{% extends 'layout_9_3_bs5.html' %}
{% load redpot_tags %}
{% load tutor_module_tags %}
{% load render_table from django_tables2 %}

{% block right_sidebar %}
    {% include 'core/components/side_nav.html' %}
{% endblock %}

{% block center %}
    <div class="section">
    {% if student.sits_id %}
    <div class="section-alert-header alert-warning" role="alert">
        <span class="fa fa-exclamation-circle"></span>
        <b>This student has a record in SITS and some of its data is now read only.</b>
    </div>
    {% endif %}

    {% if student.is_flagged %}
    <div class="section-alert-header alert-danger" role="alert">
        <span class="fa fa-exclamation-circle"></span>
        <b>This person has been flagged: {{ student.note }}</b>
    </div>
    {% endif %}

    {% if student.deceased %}
    <div class="section-alert-header alert-danger" role="alert">
        <span class="fa fa-exclamation-circle"></span>
        <b>This person is deceased</b>
    </div>
    {% endif %}

    {% if suspension and suspension.actual_return_date %}
    <div class="section-alert-header alert-warning" role="alert">
        <span class="fa fa-exclamation-circle"></span>
        <b>This student has suspended their award bearing studies since {{ suspension.start_date }}</b>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-sm-12">
            {% edit_button student %}
            <h2 id='student' class='section-title'>Personal details</h2>
            <hr>
        </div>
        <div class="col-sm-12 col-md-6">
            <dl class="row">
                <dt class="col-sm-4">Title</dt><dd class="col-sm-8 mb-0">{{ student.title | default:'–'  }}</dd>
                <dt class="col-sm-4">Surname</dt><dd class="col-sm-8 mb-0">{{ student.surname }}</dd>
                <dt class="col-sm-4">First name</dt><dd class="col-sm-8 mb-0">{{ student.firstname }}</dd>
                <dt class="col-sm-4">Middle names</dt><dd class="col-sm-8 mb-0">{{ student.middlename | default:'–' }}</dd>
                <dt class="col-sm-4">Nickname</dt><dd class="col-sm-8 mb-0">{{ student.nickname | default:'–'  }}</dd>
                <dt class="col-sm-4">Birthdate</dt><dd class="col-sm-8 mb-0">{{ student.birthdate | default:'–'  }}</dd>
                <dt class="col-sm-4">Gender</dt><dd class="col-sm-8 mb-0">{{ student.get_gender_display }}</dd>
                <dt class="col-sm-4">HESA ID</dt><dd class="col-sm-8 mb-0">{{ student.husid | default:'–'  }}</dd>
                <dt class="col-sm-4">SITS ID</dt><dd class="col-sm-8 mb-0">{{ student.sits_id | default:'–'  }}</dd>
                <dt class="col-sm-4">Nationality</dt><dd class="col-sm-8 mb-0">{{ student.nationality.name }}</dd>
                <dt class="col-sm-4">Domicile</dt><dd class="col-sm-8 mb-0">{{ student.domicile.name }}</dd>
                <dt class="col-sm-4">Ethnicity</dt><dd class="col-sm-8 mb-0">{{ student.ethnicity.name }}</dd>
                <dt class="col-sm-4">Home/EU?</dt><dd class="col-sm-8 mb-0">{{ student.is_eu | default:'Unknown'  }}</dd>
                <dt class="col-sm-4">Occupation</dt><dd class="col-sm-8 mb-0">{{ student.occupation | default:'–'  }}</dd>
                <dt class="col-sm-4">Note</dt><dd class="col-sm-8 mb-0">{{ student.note | default:'–' }}</dd>
            </dl>
            {% if last_merger %}
            <dl class="row">
                <dt class="col-sm-4">Merged by</dt><dd class="col-sm-8 mb-0">{{ last_merger.created_by }}</dd>
                <dt class="col-sm-4">Merged on</dt><dd class="col-sm-8 mb-0">{{ last_merger.modified_on | date:'SHORT_DATE_FORMAT' }}</dd>
            </dl>
            <!-- TODO: Create Merge history link page -->
            <a href="/student/merge-history/{{ last_merger.target }}" class="btn btn-secondary btn-xs mb-3">
                <span class="fas fa-layer-group"></span> Merge history
            </a>
            {% endif %}
        </div>
        <div class="col-sm-12 col-md-6">
            <!-- TODO: Disability dropdown feature needs to be implmented -->
            <h5>
                <a data-bs-toggle="collapse" href="#collapse-disability" class="link-dark">Disability</a>
            </h5>
            <dl class="row collapse" id="collapse-disability">
                <dt class="col-sm-4">Disability</dt><dd class="col-sm-8 mb-0">{{ student.disability.description }}</dd>
                <dt class="col-sm-4">Detail</dt><dd class="col-sm-8 mb-0">{{ student.disability_detail | default:'–'  }}</dd>
                <dt class="col-sm-4">Action taken</dt><dd class="col-sm-8 mb-0">{{ student.disability_action | default:'–'  }}</dd>
            </dl>
            <h5>
                <a data-bs-toggle="collapse" href="#collapse-diet" class="link-dark">Dietary preferences</a>
                    <!-- TODO: Diet section needs to be created -->
                <small>
                    <a href="/edit/{{student.id}}/diet/{{diet.id}}"><span class="fas fa-fw fa-pencil-alt"></span></a>
                </small>
            </h5>
            <dl class="row collapse" id="collapse-diet">
                {% if diet %}
                <dt class="col-sm-3">Special diet</dt><dd class="col-sm-9 mb-0">{{ diet.type }}</dd>
                <dt class="col-sm-3">Details</dt><dd class="col-sm-9 mb-0">{{ diet.note }}</dd>
                {% else %}
                None
                {% endif %}
            </dl>
            <h5>
                <a data-bs-toggle="collapse" href="#collapse-emergency" class="link-dark">Emergency contact</a>
                <!-- TODO: Create emergency contact page  -->
                <a href="/edit/{{student.id}}/emergency_contact/{{emergency_contact.id}}"><span class="fas fa-fw fa-pencil-alt"></span></a>
            </h5>
            {% if emergency_contact %}
                <dl class="row collapse" id="collapse-emergency">
                    <dt class="col-sm-3">Name</dt><dd class="col-sm-9 mb-0">{{ emergency_contact.name }}</dd>
                    <dt class="col-sm-3">Email</dt><dd class="col-sm-9 mb-0">{{ emergency_contact.email }}</dd>
                    <dt class="col-sm-3">Phone</dt><dd class="col-sm-9 mb-0">{{ emergency_contact.phone }}</dd>
                </dl>
            {% else %}
                None
            {% endif %}
            <hr>
            <h5>Marketing</h5>
            <h6>Email</h6>
            <div class="btn-group">
                {% if student.email_optin %}
                    <a class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown">Opted in <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="/student/marketing/{{ student.id }}">{% icon_text 'Opt-out' 'fa-check text-danger' %}</a></li>
                    </ul>
                {% else %}
                    <a class="btn btn-outline-dark btn-sm dropdown-toggle" data-bs-toggle="dropdown">Not opted-in <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="/student/marketing/{{ student.id }}">{% icon_text 'Opt-in' 'fa-check text-success' %}</a></li>
                    </ul>
                {% endif %}
            </div>
            <h6>Mail</h6>
            <div class="btn-group">
                {% if student.no_publicity %}
                    <a class="btn btn-danger btn-sm dropdown-toggle" data-bs-toggle="dropdown">Opted-out <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="/student/marketing/{{ student.id }}"><span class="fa fa-check text-success"></span> Opt-in</a></li>
                    </ul>
                {% elif student.mail_optin %}
                    <a class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown">Opted in <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="/student/marketing/{{ student.id }}"><span class="fa fa-remove text-danger"></span> Opt-out</a></li>
                    </ul>
                {% else %}
                    <a class="btn btn-outline-dark btn-sm dropdown-toggle" data-bs-toggle="dropdown">Not opted-in <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="/student/marketing/{{ student.id }}"><span class="fa fa-check text-danger"></span> Opt-in</a></li>
                    </ul>
                {% endif %}
            </div>
        </div>
    </div>
    {% timestamp student %}
</div>

<div class="section">
    <div class="float-end mt-1">
        <a href="{% url 'student:address:new' student.id %}" class="btn btn-success btn-xs"><i class="fas fa-plus"></i> Add address</a>
    </div>
        <h2 id='address' class='section-title'>Address</h2>
        {% if addresses %}
        <!-- TODO : The chevron down doesn't change to chevron up when opened. Js in tools.js (I think)-->
        <ul class="item-list hide-items" data-max-item=2>
        {% for address in addresses %}
            <li class="item" data-created-on="{{ address.created_on }}">
                <div class="item-info">
                    <div class='row'>
                        <div id="addressField{{ address.id }}" class="col-sm-3">
                            <span style="white-space: pre-line;">{{ address.formatted }}</span>
                        </div>
                        <div class="col-sm-3">
                        {% if address.is_default %}
                            <span class="badge bg-primary">Default</span>
                        {% endif %}
                        {% if address.sits_type %}
                            {% if address.sits_type == 'C' %}
                                <span class="badge bg-warning">SITS Correspondence</span>
                            {% elif address.sits_type == 'H' %}
                                <span class="badge bg-warning">SITS Home</span>
                            {% else %}
                                <span class="badge bg-warning">SITS Term time</span>
                            {% endif %}
                        {% endif %}
                        {% if address.is_billing %}
                            <span class="badge bg-success"
                                data-bs-toggle="tooltip"
                                data-title="Used for invoicing"
                            >Billing</span>
                        {% endif %}
                        </div>
                        <div class="col-sm-6">
                            <div class="float-end">
                                {% if not address.is_billing %}
                                    <a
                                       class="btn btn-outline-dark hide-until-hover"
                                       data-href="{% url 'student:address-api' address.id %}"
                                       data-api-field="is_billing"
                                       data-api-value="true"
                                       data-on-success="reload"
                                    >
                                        Set billing
                                    </a>
                                {% endif %}
                                {% if not address.is_default %}
                                    <a
                                       class="btn btn-outline-dark hide-until-hover"
                                       data-href="{% url 'student:address-api' address.id %}"
                                       data-api-field="is_default"
                                       data-api-value="true"
                                       data-on-success="reload"
                                    >
                                        Set default
                                    </a>
                                {% endif %}
                                <a data-bs-toggle="tooltip" placement="top" title="Copy address to clipboard" class="btn btn-outline-dark copyAddressButton" onclick="copyToClipboardBreakLines('#addressField{{ address.id}}')">
                                    <span class="far fa-copy">
                                    </span>
                                </a>
                                {% edit_button address size='medium'%}
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        {% endfor %}
        </ul>
        {% endif %}
</div>

<div class="section">
    <div class="float-end mt-1">
        <a href="/edit/request.args(0)/email/new" class="btn btn-success btn-xs"><i class="fas fa-plus"></i> Add email</a>
    </div>

    <h2 id='email' class='section-title'>Email</h2>
    {% if emails %}
    <ul class="item-list hide-items" data-max-item=2>
    {% for email in emails %}
        <li class="item" data-created-on="{{ email.created_on }}">
            <div class='row'>
                <div class="col-sm-6">
                    <a id="dynamicUpdateEmailField_{{email.id}}" href="mailto:{{ email.email }}" class="link-dark">{{ email.email }}</a>
                    {% if email.is_default %}
                        <span class="badge bg-primary">Default</span>
                    {% endif %}
                    {% if email.created_by == 'SITS' or email.modified_by == 'SITS' %}
                        <span class="badge bg-warning">SITS</span>
                    {% endif %}
                    {% if email.note %}
                        <span data-bs-toggle="tooltip" data-title="{{ email.note }}">
                            <i class="far fa-comment"></i>
                        </span>
                    {% endif %}
                </div>
                <div class="col-sm-6">
                    <div class="float-end" style="margin:-7px 0;">
                        {% if not email.is_default %}
                            <a
                               class="btn btn-outline-dark hide-until-hover"
                               data-href="{% url 'student:email-api' email.id %}"
                               data-api-field="is_default"
                               data-api-value="true"
                               data-on-success="reload"
                            >
                                Set default
                            </a>
                        {% endif %}
                        <a data-bs-toggle="tooltip" placement="top" data-title="Copy email to clipboard" class="btn btn-outline-dark" onclick="copyToClipboard('{{email.email}}')"><span class="far fa-copy"></span></a>
                        <a href="{{ email.get_edit_url }}" class="btn btn-outline-dark"><span class="fas fa-pencil-alt"></span></a>
                    </div>
                </div>
                <div style="display:none;" class="slidingOutEmailEditing_{{email.id}}">
                    <div id="target_{{email.id}}"></div>
                </div>
            </div>
        </li>
    {% endfor %}
    </ul>
    {% endif %}
</div>

<div class="section">
    <div class="float-end mt-1">
        <a href="/edit/{{ student.id }}/phone/new" class="btn btn-success btn-xs"><i class="fas fa-plus"></i> Add phone</a>
    </div>

    <h2 id='phone' class='section-title'>Phone</h2>
    {% if phones %}
    <ul class="item-list hide-items" data-max-item=2>
    {% for phone in phones %}
        <li class="item" data-created-on="{{ phone.created_on }}">
            <div class='row'>
                <div class="col-sm-9">
                    <a href="tel:{{phone.number}}" class="link-dark">{{phone.number}}</a>
                    {% if phone.is_default %}
                        <span class="badge bg-primary">Default</span>
                    {% endif %}
                    {% if 'phone' not in 'phone.type.lower()' %}
                        <span class="badge bg-secondary">{{phone.type}}</span>
                    {% endif %}
                    {% if phone.created_by == 'SITS' or phone.modified_by == 'SITS' %}
                        <span class="badge bg-warning">SITS</span>
                    {% endif %}
                    {% if phone.note %}
                        <span data-bs-toggle="tooltip" data-title="{{ phone.note }}">
                            <i class="far fa-comment"></i>
                        </span>
                    {% endif %}
                </div>
                <div class="col-sm-3">
                    <div class="float-end" style="margin:-7px 0;">
                        {% if not phone.is_default %}
                            <a
                               class="btn btn-outline-dark hide-until-hover"
                               data-href="{% url 'student:phone-api' phone.id %}"
                               data-api-field="is_default"
                               data-api-value="true"
                               data-on-success="reload"
                            >
                                Set default
                            </a>
                        {% endif %}
                        <a href="/edit/{{ student.id }}/phone/{{ phone.id }}" class="btn btn-outline-dark"><span class="fas fa-pencil-alt"></span></a>
                    </div>
                </div>
            </div>
        </li>
    {% endfor %}
    </ul>
    {% endif %}
</div>

<div class="section">
    <h2 id='enrolments' class='section-title' data-badge-text='{{qa_list.total_enrolments}}'>Enrolments</h2>
    {% for qa in qa_list %}
    <div class='card mb-3'>
        <div class="card-header">
            <div class="float-end">
                <a href="{% url 'enrolment:create' qa.id %}" class="btn btn-success btn-xs"><i class="fas fa-plus"></i> Add enrolment</a>
            </div>

            {% if qa.qa_warning %}
            <span title="Contains a Credit-bearing module" class="text-danger">
                <span class="fa fa-exclamation-circle"></span>
            </span>
            {% endif %}

            <a href="{{ qa.get_absolute_url }}" class="link-dark"><b>{{ qa.title }}</b></a>
            <small> &bull; {{ qa.enrolments.count }} course{{ qa.enrolments.count|pluralize }}</small>

            {% if qa.programme.qualification.is_award and qa.end_date and qa.reason_for_ending %}
                {% if qa.reason_for_ending.id == 1 %}
                <span class="badge bg-success">Completed</span>
                {% else %}
                <span class="badge bg-warning">Ended</span>
                {% endif %}
            {% elif qa.programme.qualification.on_hesa_return %}
                {% if qa.points_awarded %}
                <small>&bull; {{ qa.points_awarded }} CATS points</small>
                {% endif %}
            {% endif %}

        </div>
        <ul class="item-list hide-items" data-max-item=5>
            {% for enrolment in qa.enrolments.all %}
            <li class="item" data-created-on="{{ enrolment.created_on}}">
                <div class="float-end">
                    <a href="{{ enrolment.get_absolute_url }}" class="btn btn-outline-dark"><i class="fas fa-search"></i></a>
                </div>
                <div>
                    {% if enrolment.module.credit_points and qa.non_accredited %}
                        <span title="Credit-bearing module within a non-credit-bearing programme" class="text-danger">
                            <span class="fa fa-exclamation-circle"></span>
                        </span>
                    {% endif %}
                    <a href="{{ enrolment.module.get_absolute_url }}" class="link-dark fw-semi-bold">{{ enrolment.module.title }}</a>
                </div>
                <div>
                    <a href="{{ enrolment.module.get_absolute_url }}" class="link-dark">{{ enrolment.module.code }}</a>
                    &bull; {{ enrolment.module.start_date }}
                    {% if enrolment.module.end_date and enrolment.module.end_date != enrolment.module.start_date %}
                        &ndash; {{enrolment.module.end_date}}
                    {% endif %}
                    {% enrolment_label enrolment.status.id enrolment.status %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
    <a class="btn btn-success" href="{% url 'qualification_aim:new' student.id %}">{% icon_text 'Add programme' 'fa-plus' %}</a>
    <a class="btn btn-secondary" href="/waitlist/add/{{student.id}}">{% icon_text 'Add to waiting list' 'fa-list' %}</a>

    <div class="btn-group float-end">
        <button type="button" class="btn btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="fa fa-file"></span> Documents <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li><a class="dropdown-item" href="/student/statement/{{student.id}}" target="_blank">{% icon_text 'Statement' 'fa-pound-sign' %}</a></li>
            {% if qa_list.qa_certhe %}
            <li><a class="dropdown-item" href="/student/certhe_progress/{{student.id}}" target="_blank">{% icon_text 'CertHE progress report' 'fa-certificate' %}</a></li>
            {% endif %}
            {% if perms.transcript.print %}
            <li class="divider"></li>
            <li class="dropdown-header">Transcripts</li>
            <li><a class="dropdown-item" href="{% url 'transcript:undergraduate' student.id %}" target="_blank">{% icon_text 'Undergraduate' 'fa-graduation-cap' %}</a></li>
            <li><a class="dropdown-item" href="{% url 'transcript:undergraduate-headed' student.id %}" target="_blank">{% icon_text 'Undergraduate (with header)' 'fa-graduation-cap' %}</a></li>
            <li><a class="dropdown-item" href="{% url 'transcript:postgraduate' student.id %}" target="_blank">{% icon_text 'Postgraduate' 'fa-graduation-cap' %}</a></li>
            <li><a class="dropdown-item" href="{% url 'transcript:postgraduate-headed' student.id %}" target="_blank">{% icon_text 'Postgraduate (with header)' 'fa-graduation-cap' %}</a></li>
            {% endif %}
        </ul>
    </div>
</div>

{% if waitlists %}
<div class="section">
    <h2 id='waitlists' class='section-title' data-badge-text='{{ waitlists.count }}'>Waiting lists</h2>
    <table class="table table-striped table-hover hide-rows" data-display='3'>
        <thead><tr><th>Module</th><th>Title</th><th>Listed on</th></tr></thead>
        {% for waitlist in waitlists %}
        <tr>
            <td><a href="{{ waitlist.module.get_absolute_url }}">{{ waitlist.module.code }}</a></td>
            <td><a href="{{ waitlist.module.get_absolute_url }}">Contemporary Irish Fiction</a></td>
            <td>{{ waitlist.listed_on | date:'d M Y H:i' }}</td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

{% if course_applications %}
<div class="section">
    <h2 id='applications' class='section-title' data-badge-text='{{course_applications.count}}'>Applications</h2>
    <table class="table table-striped table-hover hide-rows" data-display='3'>
    <thead><tr><th></th><th></th><th></th><th></th></tr></thead>
    {% for application in course_applications %}
        <tr>
            <td><a href="{{ application.module.get_absolute_url }}">{{ application.module.code }}</a></td>
            <td><a href="{{ application.module.get_absolute_url }}">{{ application.module.title }}</a></td>
            <td>
                {% if application.is_completed %}
                <span class="badge bg-success">Completed</span>
                {% else %}
                <span class="badge bg-secondary">In progress</span>
                {% endif %}
            </td>
            <td><a href="/form/view/{{ application.id }}"><span class="fas fa-pencil-alt"></span></a></td>
        </tr>
    {% endfor %}
    </table>
</div>
{% endif %}

<div class="section">
    <div class="float-end mt-1">
        <a href="{% url 'invoice:choose-enrolments' student.id %}" class="btn btn-success btn-xs"><i class="fas fa-plus"></i> Add invoice</a>
    </div>
    <h2 id='invoices' class='section-title' data-badge-text='' data-badge-class='warning'>Invoices</h2>
    {% if invoices %}
    <ul class="item-list hide-items" data-max-item=2>
        {% for invoice in invoices %}
        <li class="item" data-created-on="{{ invoice.created_on }}">
            <div>
                <div class="float-end">
                    <a href="{{ invoice.get_absolute_url }}" class="btn btn-outline-dark"><span class="fa fa-search"></span></a>
                </div>
                <a href="{{ invoice.get_absolute_url }}" class="link-dark fw-semi-bold">
                    {{invoice}} &bull; {{invoice.ledger_items.first.enrolment.module}}
                </a>
            </div>
            <div>
                Raised {{ invoice.date | date:'d M Y' }} &bull; £{{ invoice.amount | floatformat:-2 }}
                {% if not invoice.balance %}
                    {% if invoice.written_off %}
                    <span class="badge bg-primary">Written off</span>
                    {% else %}
                    <span class="badge bg-success">Paid</span>
                    {% endif %}
                {% elif invoice.balance < 0 %}
                <span class="badge bg-warning">£{{ invoice.balance | floatformat:-2 }} In credit</span>
                {% elif invoice.payment_plan.id %}
                    <span class="badge bg-warning">£{{ invoice.balance | floatformat:-2 }} Outstanding</span>
                    <span class="badge bg-primary">Payment plan</span>
                {% elif invoice.duedate and invoice.duedate < now %}
                    <span class="badge bg-danger">£{{ invoice.balance | floatformat:-2 }} Overdue</span>
                {% else %}
                    <span class="badge bg-warning">£{{ invoice.balance | floatformat:-2 }} Outstanding</span>
                {% endif %}
            </div>
        </li>
        {% endfor %}
    </ul>
    {% endif %}
</div>

<div class="section">
    <div class="float-end mt-1">
        <a href="{% url 'website_account:create' student.id %}" class="btn btn-success btn-xs">
            <i class="fas fa-plus"></i> Add login
        </a>
    </div>

    <h2 id='login' class='section-title'>Login</h2>

    {% if website_accounts %}
    <ul class="item-list hide-items" data-max-item=1>
        {% for login in website_accounts %}
        <li class="item">
            <div>
                <div class="float-end">
                    <a href="{% url 'website_account:edit' login.id %}" class="btn btn-outline-dark">
                        <i class="fas fa-pencil-alt"></i>
                    </a>
                </div>
                <span class="fw-semi-bold">{{ login.username }}</span>
                {% if login.is_disabled %}
                <span class="badge bg-danger">Disabled</span>
                {% endif %}
            </div>
            <div>
                Last logged in
                <span class="timeago"
                      datetime="{{ login.last_login}}"
                      data-bs-toggle="tooltip"
                      data-placement="bottom"
                      data-title="{{ login.last_login | date:'j M Y H:i' }}"
                >
                    {{ login.last_login }}
                </span>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% endif %}
</div>


<div class="section">
    <div class="float-end mt-1">
        <a href="other_id/new/{{ student.id }}" class="btn btn-success btn-xs"><i class="fas fa-plus"></i> Add other ID</a>
    </div>
    <h2 id='other_ids' class='section-title'>Other IDs</h2>
    {% if other_ids %}
    <table class="table table-striped table-hover hide-rows" data-display='3'>
        <thead><tr><th>ID</th><th>Type</th><th>End date</th><th></th></tr></thead>
        <tbody>
        {% for other_id in other_ids %}
            <tr>
                <td>{{ other_id.number }}</td>
                <td>{{ other_id.type.description }}</td>
                <td>{% if other_id.end_date %}{{ other_id.end_date  }}{% else %}{% endif %}</td>
                <td class="col-sm-1">
                    <a href="/other-id/edit/{{ other_id.id }}"><span class="fas fa-fw fa-pencil-alt"></span></a>
                    {% comment %} {% if auth.has_membership('dev') %} {% endcomment %}
                    <a href="/other-id/delete/{{ other_id.id }}"><span class="fas fa-times"></span></a>
                    {% comment %} {% endif %} {% endcomment %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <dl class='row'><dt class="col-sm-2"> Moodle ID</dt>
    {% if moodle_id %}
        <dd class="col-sm-6 mb-0">{{ moodle_id.id }} <a href="/moodle-id/edit/{{ moodle_id.id }}"><span class="fas fa-fw fa-pencil-alt"></span></a></dd>
    {% else %}
        <dd class="col-sm-6 mb-0">N/A <a href="/moodle-id/new/{{ student.id }}"><i class="fas fa-plus"></i></a></dd>
    {% endif %}
    </dl>

</div>

<div class="section">
    <div class="float-end mt-1">
        <a href="/enquiry/new/{{ student.id }}" class="btn btn-success btn-xs"><i class="fas fa-plus"></i> Add enquiries</a>
    </div>
    <h2 id='enquiries' class='section-title'>Enquiries</h2>
    {% if enquiries %}
    <table class="table table-striped table-hover hide-rows" data-display='3'>
    <thead><tr><th>Date</th><th>Module</th><th>Title</th><th>Details</th><th></th></tr></thead>
    <tbody>
    {% for enquiry in enquiries %}
        <tr>
            <td>{{ enquiry.date | date:'SHORT_DATE_FORMAT' }}</td>
            <td><a href="/redpot/module/view/{{ enquiry.module.id }}">{{ enquiry.module.code }}</a></td>
            <td>{{ enquiry.module.title }}</td>
            <td><a class="set-default-hover" data-content="{{ enquiry.module.title }} ({{ enquiry.module.code }}): Please add me to the waiting list for spaces on this course" data-html="true" data-placement="left" data-bs-toggle="popover" data-trigger="hover" data-original-title="" title=""><span class="fa fa-ellipsis-h"></span></a></td>
            <td class="col-sm-1"><a href="/redpot/enquiry/edit/{{ enquiry.id }}"><span class="fas fa-fw fa-pencil-alt"></span></a></td>
        </tr>
    {% endfor %}
    </tbody>
    </table>
    {% endif %}
</div>

{% if tutor.id %}
<div class="section">
    {% edit_button tutor %}
    {% if tutor.rtw_expired %}
    <div class="section-alert-header alert-danger">
            <span class="fa fa-exclamation-circle"></span>
            <b>This tutor's right to work has expired</b>
    </div>
    {% elif tutor.rtw_expires_soon %}
    <div class="section-alert-header alert-danger">
        <span class="fa fa-exclamation-circle"></span>
        <b>This tutor's right to work will expire within 6 months</b>
    </div>
    {% endif %}

    <h2 id='tutor' class='section-title'>Tutor details</h2>
    <hr>
    <dl class="row">
        <dt class="col-sm-3">Qualifications</dt>
        <dd class="col-sm-9 mb-0">{{ tutor.qualifications | default:'–'  }}</dd>
        <dt class="col-sm-3">Affiliation</dt>
        <dd class="col-sm-9 mb-0">{{ tutor.affiliation | default:'–'  }}</dd>
        {% if perms.tutor.edit_bank_details %}
            <dt class="col-sm-3">National Insurance # </dt><dd class="col-sm-9 mb-0">{{ tutor.nino | default:'–' }}</dd>
            <dt class="col-sm-3">Employee #</dt>
            {% if tutor.employee_no %}
                <dd class="col-sm-9 mb-0">{{tutor.employee_no}}</dd>
            {% else %}
                <dd class="col-sm-9 mb-0"><span class="text-danger"><b>None</b></span></dd>
            {% endif %}
            <dt class="col-sm-3">Appointment ID</dt>
            {% if tutor.appointment_id %}
                <dd class="col-sm-9 mb-0">{{tutor.appointment_id}}</dd>
            {% else %}
                <dd class="col-sm-9 mb-0"><span class="text-danger"><b>None</b></span></dd>
            {% endif %}
        {% endif %}
        <dt class="col-sm-3">Oracle supplier number</dt>
        <dd class="col-sm-9 mb-0">{{ tutor.oracle_supplier_number | default:'–' }}</dd>
    </dl>
    {% if perms.tutor.edit_bank_details %}
        <h5>Bank details</h5>
        <dl class="row">
            <dt class="col-sm-3">Bank name</dt><dd class="col-sm-9 mb-0">{{ tutor.bankname | default:'–' }}</dd>
            <dt class="col-sm-3">Branch address</dt><dd class="col-sm-9 mb-0">{{ tutor.branchaddress | default:'–' }}</dd>
            <dt class="col-sm-3">Account name</dt><dd class="col-sm-9 mb-0">{{ tutor.accountname | default:'–' }}</dd>
            <dt class="col-sm-3">Sort code</dt><dd class="col-sm-9 mb-0">{{ tutor.sortcode | default:'–' }}</dd>
            <dt class="col-sm-3">Account # </dt><dd class="col-sm-9 mb-0">{{ tutor.accountno | default:'–' }}</dd>
            <dt class="col-sm-3">SWIFT</dt><dd class="col-sm-9 mb-0">{{ tutor.swift | default:'–' }}</dd>
            <dt class="col-sm-3">IBAN</dt><dd class="col-sm-9 mb-0">{{ tutor.iban | default:'–' }}</dd>
            <dt class="col-sm-3">Other bank details</dt><dd class="col-sm-9 mb-0">{{ tutor.other_bank_details | default:'–' }}</dd>
        </dl>
    {% endif %}

    {% if tutor.image %}
        <div class='col-sm-3' style="width:100px; height:85px; max-width:100px; overflow:hidden; margin: 0 10px 0 0;">
            <img src="/mnt/images/tutors/{{tutor.image}}" width="100px" align="left">
        </div>
    {% endif %}
    <br>

    <h5>Biography</h5>
    <div class='card bg-light mb-3'>
        <div class="card-body">
            {{tutor.custom_biography}}
        </div>
    </div>

    {% if tutor.tutorsubjects.all %}
        <h5>Subjects</h5>
        {% for tutor_subject in tutor.tutorsubjects.all %}
            <span class="badge bg-warning">{{ tutor_subject.subject }}</span>
        {% endfor %}
    {% endif %}

    {% if perms.tutor.edit_bank_details %}
        <h5>Right to work
            <small><a href="{% url 'tutor:right-to-work' tutor.id %}">
                <i class="fas fa-fw fa-pencil-alt"></i>
            </a></small>
        </h5>
        <dl class="row">
            <dt class="col-sm-3">List</dt><dd class="col-sm-9 mb-0">{{ tutor.get_rtw_type_display | default:'–' }}</dd>
            <dt class="col-sm-3">Document type</dt><dd class="col-sm-9 mb-0">{{ tutor.rtw_document_type | default:'–'}}</dd>
            <dt class="col-sm-3">Document issued on</dt><dd class="col-sm-9 mb-0">{{ tutor.rtw_start_date | default:'–' }}</dd>
            <dt class="col-sm-3">Document valid until</dt><dd class="col-sm-9 mb-0">{{ tutor.rtw_end_date | default:'–' }}</dd>
            <dt class="col-sm-3">Date check done</dt><dd class="col-sm-9 mb-0">{{ tutor.rtw_check_on | default:'–' }}</dd>
            <dt class="col-sm-3">Check done by</dt><dd class="col-sm-9 mb-0">{{ tutor.rtw_check_by | default:'–' }}</dd>
        </dl>
    {% endif %}

    {% timestamp tutor %}
</div>

<div class="section">
    <div class="float-end mt-1">
        <a href="{% url 'tutor:module:new' %}?tutor={{ tutor.id }}&next={{ request.path }}#tutor-modules" class="btn btn-success btn-xs">
            <i class="fas fa-plus"></i> Add module
        </a>
    </div>
    <h2 id='tutor-modules' class='section-title' data-badge-text='{{tutor_modules.count}}'>Tutor modules</h2>
    {% if tutor_roles %}
        <form action="" method="get" class="col-5">
            <div class="form-group">
                <div class="input-group">
                    <select class="form-control" id="search_modules_by_roles_tutor_role" name="tutor_role">
                        {% for role in tutor_roles %}
                            <option {% if role == tutor_module_role %} selected{% endif %} >{{role}}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-outline-primary">Filter by Roles</button>
                </div>
            </div>
        </form>
    {% endif %}
    <div class="float-end">Showing {{tutor_modules_query | length}} results out of {{tutor_modules.count}}</div>
    <br>
    <br>
    <ul class="item-list hide-items" id="tutor-list" data-max-item=4>

    {% for tutor_module in tutor_modules_query %}
    <li class="item" data-created-on="{{ tutor_module.created_on }}">
        <div class="item-title">
            <div class='row'>
                <div class="col-sm-5">
                    <a href="{{ tutor_module.module.get_absolute_url }}" class="link-dark fw-semi-bold">{{tutor_module.module.title}}</a>
                </div>
                <div class="col-sm-4">
                    {% if tutor_module.role %}
                    <span class="badge bg-primary">{{tutor_module.role}}</span>
                    {% endif %}
                    {% if tutor_module.is_published %}
                    <span class="badge bg-success" data-bs-toggle="tooltip" data-title="This tutor is visible on the course webpage">Published</span>
                    {% endif %}
                </div>
                <div class="col-sm-2">
                    {% if not tutor_module.module.is_cancelled %}
                        {{tutor_module.module.enrolments.count}}/{{ tutor_module.module.max_size | default:'∞' }}
                    {% else %}
                        <span class="badge bg-danger">Cancelled</span>
                    {% endif %}
                </div>
                <div class="col-sm-1">
                    <div class="float-end">
                        {% tutor_module_menu tutor_module %}
                    </div>
                </div>
            </div>
        </div>
        <div class="item-info">
            <div class='row'>
                <div class="col-sm-5">
                    <a href="{{ tutor_module.module.get_absolute_url }}" class="link-dark">{{tutor_module.module.code}}</a> &bull;
                    {% if tutor_module.module.start_date == tutor_module.module.end_date %}
                        {{tutor_module.module.start_date}}
                    {% else %}
                        {{tutor_module.module.start_date}} &ndash; {{tutor_module.module.end_date}}
                    {% endif %}
                </div>
            </div>
        </div>
    </li>
    {% endfor %}
    {% bootstrap3modal modal_id='confirm-remove-tutor' body='Are you sure you wish to remove this tutor from the module?' confirm_text='Remove' confirm_class='danger' %}
    </ul>
</div>

<div class="section">
    <div class="float-end mt-1">
        <a href="/activity/new/{{ tutor.id }}&next={{ request.path }}#tutor-activity" class="btn btn-success btn-xs">
            <i class="fas fa-plus"></i> Add activity
        </a>
    </div>

    <h2 id='tutor-activity' class='section-title'>Other tutor activity</h2>
    <table class="table table-striped table-hover hide-rows" data-display='2' data-hide-after='2'>
    <thead><tr><th>Type</th><th>Note</th><th>Date</th><th></th></tr></thead>
    <tbody>
    {% for tutor_activity in tutor_activities %}
        <tr>
            <td>{{tutor_activity.activity.description}}</td>
            <td>{{tutor_activity.note}}</td>
            <td>{{tutor_activity.date}}</td>
            <td class="col-sm-1">
                <a data-href="/tutor-activity/delete/{{tutor_activity.id}}?_next=%2Fredpot%2Fstudent%2Fview%2F{{student.id}}%23tutor-activity" data-bs-target="#confirm-remove-activity" data-bs-toggle="modal" href="#"><span class="fas fa-times"></span></a>
                <a href="/tutor-activity/edit/{{tutor_activity.id}}?_next=%2Fredpot%2Fstudent%2Fview%2F{{student.id}}%23tutor-activity"><span class="fas fa-fw fa-pencil-alt"></span></a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
    </table>
</div>

{% else %}
<div class="section">
    <h2 id='tutor' class='section-title'>Tutor details</h2>
    <p>This person is a not a tutor.</p>
    <a class="btn btn-success" href="{% url 'student:make-tutor' student.id %}">
        <i class="fas fa-plus"></i> Make tutor
    </a>
</div>
{% endif %}

<!-- TODO : Does this remain here or do we move this elsewhere? -->
<script>
    function copyToClipboard(copiedText) {
        var newDocumentElement = document.createElement("input");
        document.body.appendChild(newDocumentElement);
        newDocumentElement.setAttribute('value', copiedText);
        newDocumentElement.select();
        document.execCommand("copy");
        document.body.removeChild(newDocumentElement);
    }

    function copyToClipboardBreakLines(element) {
        var text = $(element).clone().text();
        text = text.replace(/  /g, "");
        element = $('<textarea>').appendTo('body').val(text).select();
        document.execCommand('copy');
        element.remove();
    }

</script>

<script>
    // todo: proper generic method
    function api_update() {
        const success_actions = {
            'reload': (data) => {
                window.location.reload();
            },
        }
        const element = $(this)[0];
        let val;
        if (element.type === 'checkbox') {
            val = $(this).prop('checked')
        } else {
            val = $(this).data('api-value');
        }
        let data = {};
        data[$(this).data('api-field')] = val;
        let url = $(this).data('href');
        $.ajax({
            type: "PATCH",
            headers:{"X-CSRFToken": "{{ csrf_token }}"},
            url: url,
            data: data,
            success: success_actions[$(this).data('on-success')]
        });
    }

    $("[data-api-field]").change(api_update).click(api_update);
</script>

{% endblock %}
