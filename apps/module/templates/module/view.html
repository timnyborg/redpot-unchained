{% extends 'layout_9_3.html' %}
{% load redpot_tags %}
{% load tutor_module_tags %}
{% load render_table from django_tables2 %}

{% block right_sidebar %}
<div class="hidden-xs affix-top" data-spy="affix" data-offset-top="105" id="sidebar">
    <ul class="nav sidenav">
    </ul>
</div>
{% endblock %}

{% block center %}

<div class="section">
    {% if module.is_cancelled %}
        <div class="section-alert-header alert-danger" role="alert">
            <i class="fa fa-exclamation-circle"></i>
            <b>Course cancelled</b>
        </div>
    {% endif %}
    <div class='row'>
        <div class='col-md-4 col-md-push-8'>
            <h3>Web publication</h3>
            {% if module.is_publishable %}
                <h5>This course can be published</h5>
            {% else %}
                <h5>This course cannot be published</h5>
                <p>
                    {% for error in module.publish_errors.values %}
                    <span class="text-danger"><i class="fas fa-fw fa-times"></i>
                                        {{ error }}
                                    </span><br/>
                    {% endfor %}
                </p>
            {% endif %}

            {% if module.auto_publish %}
                <div class="btn-group">
                    <a href="#" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                        <i class="fas fa-cog"></i>
                        Automatic
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="/manual_publish/{{ module.id }}">
                                <span class="fas fa-user"></span> Manual
                            </a>
                        </li>
                    </ul>
                </div>
            {% else %}
                <div class="btn-group">
                    <a href="#" class="btn btn-warning dropdown-toggle" data-toggle="dropdown">
                        <i class="fas fa-fw fa-user"></i>
                        Manual
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="auto-publish/{{ module.id }}">
                                <div class="context-menu-item" >
                                    <i class="fas fa-fw fa-cog fa-pull-left"></i>
                                    <div class="description">
                                        <strong>Automatic</strong>
                                        <span>The course will be published and unpublished on the set dates. Its status
                                            will be changed according to the open, closed, start, and end dates.
                                        </span>
                                    </div>
                                </div>
                            </a>
                        </li>
                    </ul>
                </div>
            {% endif %}


            {% if module.is_published %}
                <div class="btn-group">
                    <a href="#" class="btn btn-success dropdown-toggle" data-toggle="dropdown">
                        <i class="fas fa-fw fa-play"></i>
                        Published
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="unpublish/{{ module.id }}">
                                <i class="fas fa-fw fa-stop"></i> Unpublish
                            </a>
                        </li>
                    </ul>
                </div>
            {% else %}
                <div class="btn-group">
                    <a href="#" class="btn btn-danger dropdown-toggle" data-toggle="dropdown">
                        <i class="fas fa-fw fa-stop"></i>
                        Unpublished
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="publish/{{ module.id }}">
                                <i class="fas fa-fw fa-play"></i> Publish
                            </a>
                        </li>
                    </ul>
                </div>
            {% endif %}

            <p></p>
            <!--validation for annual prospectus publication-->
            {# todo: implement #}
            {% if prospectus_check.included %}
                {% if prospectus_check.accepted %}
                    <p>
                        <i class="fas fa-check text-success">
                            This course will be included in the {{ 'YEAR' }} prospectus
                        </i>
                    </p>
                {% else %}
                    {% verbatim %}
                    <h5>This course is not yet eligible for the {{=prospectus_check.prospectus_year}} prospectus</h5>
                    {{for field, error in prospectus_check.error.items():
                        =P(SPAN(_class='fa fa-times text-danger'), prospectus_error_messages[field]) if error else ''
                    pass}}
                    {% endverbatim %}
                {% endif %}
            {% endif %}

            <p></p>
            <h5>Course status</h5>
            <div class="btn-group" >
                {# todo: implement locking on auto_publishing or cancelled #}
                <a href="#" class="btn btn-primary" data-toggle="dropdown">
                    {{ module.status }}
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    {% for status in statuses %}
                        <li>
                            <a href="set-status/{{ module.id }}/{{ status.id }}">
                                {{ status }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <p>
                <div class="btn-group">
                    <a href="{{ module.get_website_url }}" target="_blank" class="btn btn-default">
                        <i class="fas fa-fw fa-globe"></i> Webpage
                    </a>
                </div>
            </p>

            <hr>
            {% verbatim %}
            <!-- Auto remainders / feedback set to off / on upon course cancellations and uncancellations respectively-->
            <h5>Automated reminders</h5>
            {% if module.reminder_sent_on %}
                <h4>
                <span class="label label-success">
                    {{=icon_text('Sent on %s' % formatdate(module.reminder_sent_on), 'envelope')}}
                </span>
                </h4>

            {{elif module.auto_reminder:}}
                <div class="btn-group">
                    {{=A(icon_text('Enabled ', 'check'), SPAN(_class='caret'), _href='#', _class='btn btn-success dropdown-toggle', data={'toggle':'dropdown'})}}
                    <ul class="dropdown-menu">
                        <li>{{=A(icon_text('Disable', 'remove'), _href=URL('toggle_auto_reminder', args=module.id))}}</li>
                    </ul>
                </div>

            {% else %}
                <div class="btn-group">
                    {{=A(icon_text('Disabled ', 'remove'), SPAN(_class='caret'), _href='#', _class='btn btn-danger dropdown-toggle', data={'toggle':'dropdown'})}}
                    <ul class="dropdown-menu">
                        <li>
                            {{=rich_menu_item(
                                url=URL('toggle_auto_reminder', args=module.id), _icon='check', header='Enable',
                                text='Students will be emailed a reminder about the course, 5 days before it starts.')
                            }}
                        </li>
                    </ul>
                </div>
            {% endif %}
            <div class="btn-group">
                {{=A(icon_text('Preview', 'exclamation'), _href=URL('notify','precourse','index',args=module.code), _target='_blank', _class='btn btn-default')}}
            </div>

            <hr>

            <h5>Automated feedback</h5>
            {% if module.auto_feedback %}
                <div class="btn-group">
                    {{=A(icon_text('Enabled ', 'check'), SPAN(_class='caret'), _href='#', _class='btn btn-success dropdown-toggle', data={'toggle':'dropdown'})}}
                    <ul class="dropdown-menu">
                        <li>{{=A(icon_text('Disable', 'remove'), _href=URL('disable_feedback', args=module.id))}}</li>
                    </ul>
                </div>
                <div class="btn-group">
                    {{=A(icon_text('View', 'exclamation'), _href=URL('feedback','results','module',args=module.code), _target='_blank', _class='btn btn-default')}}
                </div>
            {% else %}
                <div class="btn-group">
                    {{=A(icon_text('Disabled ', 'remove'), SPAN(_class='caret'), _href='#', _class='btn btn-danger dropdown-toggle', data={'toggle':'dropdown'})}}
                    <ul class="dropdown-menu">
                        <li>
                            {{=rich_menu_item(
                                url=URL('enable_feedback', args=module.id), _icon='check', header='Enable',
                                text='Students will be emailed to request feedback the morning after the course ends.')
                            }}
                        </li>
                    </ul>
                </div>
            {% endif %}
            {% endverbatim %}
            <hr>
            <h3>Data tools</h3>
            <p>
                {% if module.is_cancelled %}
                <a class="btn btn-danger" href="uncancel/{{ module.id }}">
                    <i class="fas fa-fw fa-times"></i> Uncancel module
                </a>
                {% else %}
                <a class="btn btn-danger" href="cancel/{{ module.id }}">
                    <i class="fas fa-fw fa-times"></i> Cancel module
                </a>
                {% endif %}
            </p>
            <p>
              <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    <span class="fas fa-cog fa-fw "></span> Other <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    <li><a href="create-moodle-ids/{{ module.id }}"><span class="fas fa-fw fa-id-card"></span> Assign Moodle IDs</a></li>
                    <li><a href="award_points/{{ module.id }}"><span class="fas fa-fw fa-graduation-cap"></span> Award CATS points</a></li>
                    <li><a href="clone/{{ module.id }}"><span class="fas fa-fw fa-files-o"></span> Clone this module</a></li>
                    <li><a href="copy_fields/{{ module.id }}"><span class="fas fa-fw fa-paste"></span> Copy web fields</a></li>
                    <li><a href="import_from_template/{{ module.id }}"><span class="fas fa-fw fa-upload"></span> Import students from template</a></li>
                    {% if perms.cabs and module.portfolio == 32 and module.room and module.room_setup %}
                        {# todo: handle this logic better (elsewhere as can_send_to_cabs or something) #}
                        <li><a href="cabs_booking/{{ module.id }}"><span class="fas fa-fw fa-taxi"></span> Book course into CABS</a></li>
                    {% endif %}
                </ul>
              </div>
            </p>
            <p>
                <div class="btn-group">
                    <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                        <span class="fas fa-fw fa-file-alt"></span> Reports <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="http://square/reports/report/Finance/Financial%20report%20per%20module?code={{ module.code }}" target="_blank"><span class="fas fa-fw fa-gbp"></span> Financial statement</a></li>
                        <li><a href="financial_statement', args=[module.id, 'summary']"><span class="fas fa-fw fa-gbp"></span> Financial statement (summary)</a></li>
                        <li><a href="catering/{{ module.id }}"><span class="fas fa-fw fa-cutlery"></span> Catering</a></li>
                        <li><a href="accommodation/{{ module.id }}"><span class="fas fa-fw fa-hotel"></span> Accommodation</a></li>
                        <li><a href="module', 'refund_request/{{ module.id }}"><span class="fas fa-fw fa-gbp"></span> Refund request (.docx)</a></li>
                        <li><a href="class_register/{{ module.id }}"><span class="fas fa-fw fa-file-word-o"></span> Class register (.docx)</a></li>
                        {# todo: better portfolio logic, relying on tags #}
                        {% if module.portfolio  in '32, 17' %}
                        <li><a href="syllabus/{{ module.id }}"><span class="fas fa-fw fa-th-list"></span> Weekly class syllabus</a></li>
                        {% endif %}
                        {% if module.portfolio_id == 32 %}
                        <li><a href="WWW_ADDRESS+'/courses/reading-list-pdf/'+module.code"><span class="fas fa-fw fa-file-word-o"></span> Reading list for students (.pdf)</a></li>
                        {% endif %}
                        <li role="separator" class="divider"></li>
                        <li><a href="student_list/{{ module.id }}"><span class="fas fa-fw fa-file-excel-o"></span> Student list (.xlsx)</a></li>
                        {% if module.portfolio_id == 17 %}
                        <li><a href="moodle_list/{{ module.id }}"><span class="fas fa-fw fa-file-excel-o"></span> Moodle student list (.xlsx)</a></li>
                        {% endif %}
                        {% if module.code|slice:'-3:' == 'HEC' %}
                        <li><a href="student','certhe_progress', args=(0,module.id)"><span class="fas fa-fw fa-certificate"></span> CertHE progress report (.docx)</a></li>
                        {% endif %}
                    </ul>
                </div>
            </p>
        </div>

        <div class='col-md-8 col-md-pull-4'>
            <hr class='visible-xs visible-sm'>
            {% edit_button module.get_edit_url %}
            <a id='details' class='nav-anchor'></a>
            <h2>Details</h2>

            <dl class="dl-horizontal">
                <dt>URL</dt>
                <dd>{{ module.url }}</dd>
                <dt>Division</dt>
                <dd>{{ module.division }}</dd>
                <dt>Portfolio</dt>
                <dd>{{ module.portfolio }}</dd>
                <dt>Format</dt>
                <dd>{{ module.format }}</dd>
                <dt>Finance code</dt><dd>{{ module.finance_code }}</dd>
                <dt>Class size</dt>
                <dd>{{ module.max_size }}</dd>
                {% if module.no_meetings %}
                    <dt># of meetings</dt>
                    <dd>{{ module.no_meetings }}</dd>
                {% endif %}
                {% if module.credit_points %}
                    <dt>Credit points</dt>
                    <dd>{{ module.credit_points }}</dd>
                {% endif %}
                {% if module.apply_url %}
                    <dt>Apply URL</dt>
                    <dd>{{ module.apply_url }}</dd>
                {% endif %}
                <dt>Email</dt>
                <dd>{{ module.email }}</dd>
                {% if module.phone %}
                    <dt>Phone</dt>
                    <dd>{{ module.phone }}</dd>
                {% endif %}
                {% if module.note %}
                    <dt>Note</dt>
                    <dd>{{ module.note }}</dd>
                {% endif %}
            </dl>
            <h4>Dates</h4>
            <dl class="dl-horizontal">
                <dt>Start date</dt>
                <dd>{{ module.start_date | date:'j M Y (l)' }}</dd>
                <dt>End date</dt>
                <dd>{{ module.end_date | date:'j M Y (l)' }}</dd>

                <dt>Start time</dt>
                <dd>{{ module.start_time | default:'–'  }}</dd>
                <dt>End time</dt>
                <dd>{{ module.end_time | default:'–'  }}</dd>
                {% if module.meeting_time %}
                    <dt>meeting_time</dt>
                    <dd>{{ module.meeting_time }}</dd>
                {% endif %}
                <dt>Open date</dt>
                <dd>{{ module.open_date | default:'–' }}</dd>
                <dt>Closed date</dt>
                <dd>{{ module.closed_date | default:'–'  }}</dd>

                {% if module.auto_publish %}
                    <dt>Publish date</dt>
                    <dd>{{ module.publish_date | default:'–'  }}</dd>
                    <dt>Unpublish date</dt>
                    <dd>{{ module.unpublish_date | default:'–'  }}</dd>
                {% endif %}
                {% if module.michaelmas_end or module.hilary_start %}
                    <dt>michaelmas_end</dt>
                    <dd>{{ module.michaelmas_end | default:'–'  }}</dd>
                    <dt>hilary_start</dt>
                    <dd>{{ module.hilary_start | default:'–'  }}</dd>
                {% endif %}
            </dl>

            <h4>Location</h4>
            <dl class="dl-horizontal">
                <dt>Location</dt>
                <dd>{{ module.location }}</dd>
                {% if module.room %}
                    <dt>Room</dt>
                    <dd>{{ module.room }}</dd>
                {% endif %}
            </dl>

            <h4>Marketing types <small>
                <a href="/marketing_type/{{ module.id }}"><i class="fas fa-pencil-alt"></i></a>
            </small></h4>
            {% for marketing_type in module.marketing_types %}
                <span class='label label-info'>{{ marketing_type.name }}</span>
            {% endfor %}

            <h4>Subjects
                <small><a href="/subject/{{ module.id }}">
                    <i class="fas fa-pencil-alt"></i>
                </a></small>
            </h4>
            <p>
            {% for subject in module.subjects %}
                <span class='label label-warning'>{{ subject.name }}</span>
            {% endfor %}
            </p>
            {% if not module.non_credit_bearing and not module.hecos_subjects %}
                <p><span class="text-danger fa fa-exclamation-triangle"></span> <b>This module has no HESA-reporting subjects set</b></p>
            {% endif %}
        </div>
    </div>
    <br/>
    {% timestamp module %}
</div>

{% if other_runs %}
<div class="section">
    <a id='other_runs' class='nav-anchor'></a>
    <h2>Other runs</h2>
    <ul class="item-list hide-items" data-max-item=3>
    {% for other_run in other_runs %}
        <li class="item">
            <div class="row">
                <div class="item-title col-xs-12 col-md-2">
                    <a href="{{ other_run.get_absolute_url }}">{{ other_run.code }}</a>
                </div>
                <div class="item-info col-xs-6 col-md-7">
                    <a href="{{ other_run.get_absolute_url }}">{{ other_run.title }}</a>
                </div>
                <div class="item-info col-xs-6 col-md-3">
                    {{ other_run.start_date | date }}
                    {% if other_run.end_date and other_run.end_date != other_run.start_date %}
                        &ndash; {{ other_run.end_date | date }}
                    {% endif %}
                </div>
            </div>
        </li>
    {% endfor %}
    </ul>
</div>
{% endif %}

<div class="section">
    <a id='enrolments' class='nav-anchor' data-badge-text='{{ module.places_taken }} / {{ module.max_size | default:'∞' }}'></a>
    <h2>Enrolments</h2>
    <dl class='dl-horizontal'>
        <dt>Places taken<dt><dd>{{ module.places_taken }} / {{ module.max_size | default:'∞' }}</dd>
        <dt>Records<dt><dd>{{ enrolments | length }}</dd>
    </dl>
    {% if enrolments %}
        <table class="table table-condensed table-striped table-hover hide-rows">
        <thead>
            <tr>
                <th>Surname</th>
                <th>Firstname</th>
                <th>Status</th>
                {% if not module.non_credit_bearing %}
                <th>Result</th>
                <th>Points</th>
                {% endif %}
                <th></th>
            </tr>
        </thead>
    {% endif %}
    {% for enrolment in enrolments %}
        <tr>
            <td><a href="">{{ enrolment.student.surname }}</a></td>
            <td><a href="">{{ enrolment.student.firstname }}</a></td>
            <td>{{ enrolment.status.description }}</td>
            {% if not module.non_credit_bearing %}
            <td>{{ enrolment.result.description }}</td>
            <td>{{ enrolment.points_awarded | default:'–'}}</td>
            {% endif %}
            <td><a href=""><i class="fas fa-pencil-alt"></i></a></td>
        </tr>
    {% endfor %}

    </table>
    {% verbatim %}
    {{=A(icon_text('Missing student details', 'question-mark'), _class='btn btn-success', _href=URL('module', 'missing_student_details_list', args=module.id))}}
</div>


{% endverbatim %}


{% if waitlist_table.rows %}

<div class="section">
    <a id='waitlist' class='nav-anchor' data-badge-text='{{ waitlist_table.rows | length }}'></a>
    <h2>Waiting list</h2>
    <form method="post" action="/send-to-the-waiting-list">
        {% render_table waitlist_table %}
        <div class="btn-group pull-right">
            <a href="#" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
                <i class="far fa-fw fa-envelope"></i> Email entire list
                <span class="caret"></span>
            </a>
            <ul class="dropdown-menu">
                {% if next_run %}
                <li>
                    <a href="email-list/{{ module.id }}/new/{{ next_run.id }}">New run of course</a>
                </li>
                {% endif %}

                <li><a href="/email-list/{{ module.id }}/online">Places available on course (enrol online)</a></li>
                <li><a href="/email-list/{{ module.id }}/form">Places available on course (enrol by form)</a></li>
            </ul>
        </div>
        <button type="submit" value="Standard" class="btn btn-primary">
            <i class="fa fa-fw fa-envelope"></i> Email selected students
        </button>
    </form>

</div>
{% endif %}

{% verbatim %}

{% if applications %}
<div class="section">
    <a id='application_forms' class='nav-anchor'></a>
    <h2>Applications</h2>
    <table id="{{='applications' if applications and len(applications) > 10 else ''}}" class="table table-condensed table-striped table-hover hide-rows">
    <thead><tr><th>Surname</th><th>Firstname</th><th>Status</th><th></th></tr></thead>
    <tbody>

    {{for application in applications:
        edit_button = A(icon('pencil'), _href=URL('form', 'view', args=application.id))
        if application.is_completed == 1:
            status_label = SPAN('Completed', _class='label label-success')
        else:
            status_label = SPAN('In progress', _class='label label-default')
        pass

        if application.student:
            student_link = URL('student', 'view', args=application.student)
            =TR(A(application.surname, _href=student_link), A(application.fname, _href=student_link), status_label, edit_button)
        else:
            =TR(application.surname, application.fname, status_label, edit_button)
        pass
    pass}}
    </tbody>
    </table>
</div>
{% endif %}

{% endverbatim %}

<div class="section">
    <div class="btn-group btn-group-xs pull-right top-right-button">
        <a href="fee/new/{{ module.id }}" class="btn btn-success" role="button"><span class="fa fa-plus"></span> Add fees</a>
      <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <span class="caret"></span>
        <span class="sr-only">Toggle Dropdown</span>
      </button>
      <ul class="dropdown-menu">
        <li><a href="copy-fees/{{ module.id }}"><span class="fa fa-gbp"></span> Copy fees</a></li>
      </ul>
    </div>
    <a id='fees' class='nav-anchor'></a>
    <h2>Fees</h2>
    {% if fees %}
        <table class="table table-condensed table-striped table-hover">
            <thead><tr><th>Tuition</th><th></th><th></th><th></th></tr></thead>
            {% for fee in fees %}
                {% if fee.type.narrative == 'Programme fee' %}
                    <tr>
                        <td>{{ fee.description }}</td>
                        <td></td>
                        <td>£{{ fee.amount | floatformat:2 }}</td>
                        <td class="quick-icons">
                            <a href=""><i class="fas fa-pencil-alt"></i></a>
                            <a href=""><i class="fas fa-times"></i></a>
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
            <tr><th>Other</th><th></th><th></th><th></th></tr>
            {% for fee in fees %}
                {% if fee.type.narrative != 'Programme fee' %}
                    <tr>
                        <td>{{ fee.description }}
                            {% if fee.is_catering %}
                                ({{ fee.catering_booking_count }}/{{ fee.allocation | default:'∞' }})
                            {% endif %}
                        </td>
                        <td>{{ fee.type.narrative }}</td>
                        <td>£{{ fee.amount | floatformat:2 }}</td>
                        <td class="quick-icons">
                            <a href=""><i class="fas fa-pencil-alt"></i></a>
                            <a href=""><i class="fas fa-times"></i></a>
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
        </table>
    {% endif %}

    {% if discounts %}
    <table class="table table-condensed table-striped">
        <thead><tr><th>Discount codes</th><th></th><th></th></tr></thead>
        {% for discount in discounts %}
            <tr>
                <td>{{ discount }} ({{ discount.percent }}%)</td>
                <td>{{ discount.code }}</td>
                <td>
                {% if discount.all_eligible %}
                    All students eligible
                {% else %}
                    Limited eligibility (see discount manager)
                {% endif %}
                </td>
            </tr>
        {% endfor %}
    </table>
    {% endif %}
</div>

{# TODO: turn the '== 32' into a portfolio property/tag #}
{% if module.portfolio_id == 32 %}
<div class="section">
    <a id='reading-list' class='nav-anchor'></a>
    <h2>Reading list</h2>
    {% render_table book_table %}
    <br>
    <a href="rebuild_reading_list/{{ module.id }}" class="btn btn-default">
        <i class="fas fa-fw fa-redo"></i> Rebuild reading list
    </a>
    {% if perms.books.export_list %}
        {#  Todo: figure out to do with square & other external urls. simple key-value table? #}
        <a href="https://square.conted.ox.ac.uk/reports/report/Library/Weekly%20classes%20reading%20list%20items%20by%20course?code={{ module.code }}"
           target='_blank'
           class="btn btn-default"
        >
            <span class="fas fa-fw fa-check-square"></span> Export list (square)
        </a>
    {% endif %}
</div>
{% endif %}

<div class="section">
    <div class="pull-right top-right-button">
        <a href="module/add-payment-plan/{{ module.id }}" class="btn btn-success btn-xs"><span class="fa fa-plus"></span> Add Payment plan</a>
    </div>
    <a id='payment-plans' class='nav-anchor'></a>
    <h2>Payment plans</h2>
    {% if payment_plans %}
        <table class="table table-condensed table-striped table-hover" >
        <thead><tr><th>Type</th><th></th></tr></thead>
        {% for plan in payment_plans %}
            <tr>
                <td>
                    {{ plan.name }}
                </td>
                <td class="quick-icons">
                    <a href="EDIT"><i class="fas fa-fw fa-pencil-alt"></i></a>
                    <a href="DELETE"><i class="fas fa-fw fa-times"></i></a>
                </td>
            </tr>
            {# delete_button = A(icon('remove'), data={'toggle': 'modal', 'target': '#confirm-remove-plan', 'href': URL('payment_plan', args=['delete', plan.id])}, _href='#') #}
        {% endfor %}
        </table>
    {% endif %}
</div>

<div class="section">
    <div class="pull-right top-right-button">
        <a href="add_programme/{{ module.id }}?next={{ request.get_full_path }}#programmes" class="btn btn-success btn-xs">
            <span class="fa fa-plus"></span> Add Programme
        </a>
    </div>
    <a id='programmes' class='nav-anchor'></a>
    <h2>Programmes</h2>
    {% if programmes %}
    <p>This module is part of the following programmes</p>
    <table class="table table-condensed table-striped table-hover">
    <thead><tr><th>Title</th><th></th></tr></thead>
        {% for programme in programmes %}
            {# delete_button = TD(A(icon('remove'), data={'toggle': 'modal', 'target': '#confirm-remove-module', 'href': URL('programme', 'remove_module', args=row.id, vars={'_next': URL(args=request.args, anchor='programmes')})}, _href='#'), _class='span2 quick-icons') #}
            <tr>
                <td>
                    {% if programme.qualification == 1 and module.credit_points %}
                        <span title="Credit-bearing module within a non-credit-bearing programme" class="text-danger">
                            <i class="fas fa-exclamation-circle"></i>
                        </span>
                    {% endif %}
                    <a href="/programme/view/{{ programme.id }}"> {{ programme }}</a>
                </td>
                <td><a href="#"><i class="fas fa-times"></i></a></td>
            </tr>
        {% endfor %}
    </table>
    {% endif %}
</div>

<div class="section">
    <div class="pull-right top-right-button">
        <a href="/tutor_module/new/{{ module.id }}" class="btn btn-success btn-xs"><span class="fa fa-plus"></span> Add tutor</a>
    </div>
    <a id='tutor-modules' class='nav-anchor' data-badge-text='{{ tutors | length }}'></a>

    <h2>Tutors</h2>
    {% if tutors %}
        <ul class="item-list" id="tutor-list">
        {% for row in tutors %}
            <li class="item" id='tutor_modules_{{ row.tutor_module.id }}' style="position: relative;" data-created-on="{{ row.tutor_module.created_on }}">
                <div class="drag-container" style="z-index:2">
                    <span class="drag-icon"><i class="fa fa-ellipsis-v"></i></span>
                </div>
                <div class="item-info">
                    <div class='row'>
                        <div class="col-xs-4">
                            <a href="{{ row.tutor.get_absolute_url }}">{{ row.tutor.student.firstname }} {{ row.tutor.student.surname }}</a>
                        </div>
                        <div class="col-xs-6">
                           <span class="label label-primary">{{ row.role | default:''}}</span>
                        {% if row.is_published %}
                            <span class="label label-success"
                                data-toggle="tooltip"
                                data-title="This tutor is visible on the course webpage"
                            >Published</span>
                        {% endif %}
                        </div>
                        <div class="col-xs-2">
                            <div class="pull-right">
                                {% tutor_module_menu row %}
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        {% endfor %}
        </ul>
        <br>
        <div class="dropup">
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                <span class="fas fa-fw fa-file-alt"></span> Expense forms <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li class="dropdown-header">Format</li>
                {% for key, title in expense_form_options %}
                    <li><a href="{% url 'tutor:expense-form-module' module.id key %}">{{ title }}</a></li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
</div>

{% comment %}

<script>
// Use the jquery-ui sortable, function, with some great helper stuff from http://www.avtex.com/blog/2015/01/27/drag-and-drop-sorting-of-table-rows-in-priority-order/
$(document).ready(function() {
    $("#tutor-list").sortable({
        items: '> .item',
        handle: '.drag-container',
        axis: 'y',
        stop: function(event, ui) {
            var data = $(this).sortable('serialize');

            // POST to server using $.post or $.ajax
            $.ajax({
                data: data,
                type: 'POST',
                url: 'notimplemented'
            }).success(function (data, string, jqXHR) {
                console.log(data);
            });
        }
    });

    $('#applications').DataTable({
        "dom" : '<"top"i>rt<"bottom"flp><"clear">',
        "pagingType": "numbers",
        "searching": false,
        "info": false,
        "columnDefs": [{
            "targets": [3],
            "orderable": false
        }]
    });
});
</script>
{% endcomment %}

{% endblock %}
